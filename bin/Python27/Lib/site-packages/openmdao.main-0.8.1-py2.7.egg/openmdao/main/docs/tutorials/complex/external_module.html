
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Wrapping an External Module Using F2PY &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.8.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../index.html" />
    <link rel="up" title="A More Complex Tutorial Problem" href="index.html" />
    <link rel="next" title="Assemblies" href="assemblies.html" />
    <link rel="prev" title="Executing a Component in the Python Shell" href="python_shell.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="assemblies.html" title="Assemblies"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="python_shell.html" title="Executing a Component in the Python Shell"
             accesskey="P">previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../index.html" >OpenMDAO Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">A More Complex Tutorial Problem</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="wrapping-an-external-module-using-f2py">
<span id="index-0"></span><span id="id1"></span><h1>Wrapping an External Module Using F2PY<a class="headerlink" href="#wrapping-an-external-module-using-f2py" title="Permalink to this headline">Â¶</a></h1>
<p>As the most computationally intensive component, the engine model in <tt class="docutils literal"><span class="pre">engine.py</span></tt> is the main performance
bottleneck during repeated execution. As an interpreted language, Python is not the ideal choice for
implementing a numerical algorithm, particularly where performance is important. The performance of
the engine model can be improved by implementing it in a compiled language like C or Fortran.</p>
<p>Python was designed to be smoothly integrated with other languages, in
particular, C and related languages Fortran and C++. This is important for a
scripting language, where code execution is generally slower and it is often
necessary to use a compiled language like C to implement computationally
intensive functions. To complement Python&#8217;s native integration ability, the
Python community has developed some excellent tools, such as <a class="reference external" href="http://cens.ioc.ee/projects/f2py2e/">F2PY</a> (Fortran to Python) and <a class="reference internal" href="../../glossary.html#term-swig"><em class="xref std std-term">SWIG</em></a>
(Simplified Wrapper and Interface Generator), that simplify the process of
building the wrapper for a code. As the name implies, F2PY is a Python utility
that takes a Fortran source code file and compiles and generates a wrapped
object callable from Python. More information on getting your codes to run in
Python can be found in the <a class="reference internal" href="../../plugin-guide/index.html#plugin-developer-guide"><em>Plugin Developer Guide</em></a>.</p>
<p>The main algorithm in <tt class="docutils literal"><span class="pre">engine.py</span></tt> was rewritten in C as <tt class="docutils literal"><span class="pre">engine.C</span></tt>. A
wrapped shared object of <tt class="docutils literal"><span class="pre">engine.C</span></tt> was created using F2Py; this tool can
also be used to generate wrappers for C code provided that the signature file
<tt class="docutils literal"><span class="pre">engine.pyf</span></tt> is manually created. The file <tt class="docutils literal"><span class="pre">engine.pyf</span></tt> defines the
interface for the functions found in <tt class="docutils literal"><span class="pre">engine.C</span></tt>. The C code has been placed
in a function called <tt class="docutils literal"><span class="pre">RunEngineCycle</span></tt> which can be imported and takes the design and simulation
variables as inputs.</p>
<p>The intent of this exercise is not to teach you how to write a signature file. More
information on this topic can be found in <a class="reference internal" href="../../plugin-guide/extension_plugin.html#creating-an-extension-with-f2py"><em>Creating an Extension with F2PY</em></a>, while more
extensive details can be found in the <a class="reference external" href="http://cens.ioc.ee/projects/f2py2e/usersguide/index.html">F2PY Users Guide</a>.</p>
<p>The shared object can be generated using the existing signature file and C code by issuing the
following command:</p>
<div class="highlight-python"><pre>f2py engineC.pyf engineC.c -c</pre>
</div>
<p>A new Python component named <tt class="docutils literal"><span class="pre">engine_wrap_c.py</span></tt> was created to replace
<tt class="docutils literal"><span class="pre">engine.py</span></tt>. This component contains the same inputs and outputs as
<tt class="docutils literal"><span class="pre">engine.py</span></tt> but replaces the engine internal calculations with a call to
the C function <tt class="docutils literal"><span class="pre">RunEngineCycle</span></tt>. We can import and use this function just like
any Python function:</p>
<div class="highlight-python" id="code8"><div class="highlight"><pre>        
        <span class="c"># Call the C model and pass it what it needs.</span>
        
        <span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">torque</span><span class="p">,</span> <span class="n">fuel_burn</span><span class="p">,</span> <span class="n">engine_weight</span><span class="p">)</span> <span class="o">=</span> <span class="n">RunEngineCycle</span><span class="p">(</span>
                    <span class="n">stroke</span><span class="p">,</span> <span class="n">bore</span><span class="p">,</span> <span class="n">conrod</span><span class="p">,</span> <span class="n">comp_ratio</span><span class="p">,</span> <span class="n">spark_angle</span><span class="p">,</span>
                    <span class="n">n_cyl</span><span class="p">,</span> <span class="n">IVO</span><span class="p">,</span> <span class="n">IVC</span><span class="p">,</span> <span class="n">L_v</span><span class="p">,</span> <span class="n">D_v</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span>
                    <span class="n">R</span><span class="p">,</span> <span class="n">Ru</span><span class="p">,</span> <span class="n">Hu</span><span class="p">,</span> <span class="n">Tw</span><span class="p">,</span> <span class="n">AFR</span><span class="p">,</span> <span class="n">P_exth</span><span class="p">,</span>
                    <span class="n">T_amb</span><span class="p">,</span> <span class="n">P_amb</span><span class="p">,</span> <span class="n">air_density</span><span class="p">,</span> <span class="n">mw_air</span><span class="p">,</span> <span class="n">mw_fuel</span><span class="p">,</span>
                    <span class="n">RPM</span><span class="p">,</span> <span class="n">throttle</span><span class="p">,</span> <span class="n">thetastep</span><span class="p">,</span> <span class="n">fuel_density</span><span class="p">)</span>

        
        <span class="c"># Interogate results of engine simulation and store.</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">power</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torque</span> <span class="o">=</span> <span class="n">torque</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fuel_burn</span> <span class="o">=</span> <span class="n">fuel_burn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_weight</span> <span class="o">=</span> <span class="n">engine_weight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        
</pre></div>
</div>
<p>Notice that the return values are stored in lists, so a scalar value is accessed by grabbing the first
element (element zero). This is not needed for return values from Fortran codes compiled with
F2PY (arguments in Fortran functions are passed by reference), but it is needed for C codes.</p>
<p>You can compare the execution time to see how much faster the C code runs on your hardware. To
run the original Python implementation of Engine, type:</p>
<div class="highlight-python"><pre>python engine.py</pre>
</div>
<p>Note the elapsed time, which is printed after the engine completes its run. Now type:</p>
<div class="highlight-python"><pre>python engine_wrap_c.py</pre>
</div>
<p>How much faster is the C implementation? We found it to be almost 10 times as fast as the Python
implementation. Both of these scripts run the engine 50 times before termination.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

  <h4>Previous topic</h4>
  <p class="topless"><a href="python_shell.html"
                        title="previous chapter">Executing a Component in the Python Shell</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="assemblies.html"
                        title="next chapter">Assemblies</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/tutorials/complex/external_module.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="assemblies.html" title="Assemblies"
             >next</a> |</li>
        <li class="right" >
          <a href="python_shell.html" title="Executing a Component in the Python Shell"
             >previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../index.html" >OpenMDAO Tutorials</a> &raquo;</li>
          <li><a href="index.html" >A More Complex Tutorial Problem</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Aug 26, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>