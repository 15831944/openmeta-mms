
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using a MetaModel Component &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.8.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../index.html" />
    <link rel="up" title="MetaModel" href="index.html" />
    <link rel="next" title="Modeling Multiple Outputs" href="mult_outputs.html" />
    <link rel="prev" title="MetaModel" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="mult_outputs.html" title="Modeling Multiple Outputs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="MetaModel"
             accesskey="P">previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../index.html" >OpenMDAO Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">MetaModel</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="using-a-metamodel-component">
<span id="index-0"></span><span id="id1"></span><h1>Using a MetaModel Component<a class="headerlink" href="#using-a-metamodel-component" title="Permalink to this headline">Â¶</a></h1>
<p>This tutorial is a demonstration of how to construct a MetaModel of a component using a
Kriging surrogate. Generally, MetaModel capabilities are used to construct a
low computational cost replacement for an expensive component. (A more detailed description of
this class can be found under the source documentation for <a class="reference internal" href="../../srcdocs/packages/openmdao.lib.html#metamodel"><em>MetaModel</em></a>.)</p>
<p>For this example, a component was written for the <tt class="docutils literal"><span class="pre">sine</span></tt> function. This component
has only one input and one output, which will be mimicked by the MetaModel. Had
there been additional variables, access to those would also be available
through the MetaModel.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">openmdao.main.api</span> <span class="kn">import</span> <span class="n">Assembly</span><span class="p">,</span> <span class="n">Component</span><span class="p">,</span> <span class="n">SequentialWorkflow</span><span class="p">,</span> <span class="n">set_as_top</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span>

<span class="kn">from</span> <span class="nn">openmdao.lib.datatypes.api</span> <span class="kn">import</span> <span class="n">Float</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.drivers.api</span> <span class="kn">import</span> <span class="n">DOEdriver</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.doegenerators.api</span> <span class="kn">import</span> <span class="n">FullFactorial</span><span class="p">,</span> <span class="n">Uniform</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.components.api</span> <span class="kn">import</span> <span class="n">MetaModel</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.casehandlers.api</span> <span class="kn">import</span> <span class="n">CSVCaseRecorder</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.surrogatemodels.api</span> <span class="kn">import</span> <span class="n">KrigingSurrogate</span>



<span class="k">class</span> <span class="nc">Sin</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iotype</span><span class="o">=</span><span class="s">&quot;in&quot;</span><span class="p">,</span><span class="n">units</span><span class="o">=</span><span class="s">&quot;rad&quot;</span><span class="p">)</span>

    <span class="n">f_x</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">iotype</span><span class="o">=</span><span class="s">&quot;out&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_x</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>To create a MetaModel, we first define an assembly to work in. After we have
created an assembly, the MetaModel component needs to be instantiated. In this example,
the MetaModel was instantiated as <tt class="docutils literal"><span class="pre">sin_meta_model</span></tt>, making it easy to identify.</p>
<p>Once the MetaModel component is in place, the first step is to tell the MetaModel which component
it should create an approximation for.  We do this by placing the component in the <a class="reference internal" href="../../glossary.html#term-slot"><em class="xref std std-term">Slot</em></a>
called <cite>model</cite>.  For this case we are looking at the Sin component created earlier, so this is
what&#8217;s  placed in the model Slot. The MetaModel will now have the  same inputs and outputs as our
<tt class="docutils literal"><span class="pre">sine</span></tt> component (an input named <cite>x</cite> and an output named <cite>f_x</cite> copied directly from the names in
the Sine component).</p>
<p>The next step is to fill the <tt class="docutils literal"><span class="pre">default_surrogate</span></tt> Slot. In this case we set it to
KrigingSurrogate, meaning that all outputs will be modeled  with Kriging surrogate models, unless
otherwise specified. Specific surrogate models can be specified for  specific output variables. We
cover that in the next tutorial.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Simulation</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c">#Components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;sin_meta_model&quot;</span><span class="p">,</span><span class="n">MetaModel</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sin_meta_model</span><span class="o">.</span><span class="n">default_surrogate</span> <span class="o">=</span> <span class="n">KrigingSurrogate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sin_meta_model</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Sin</span><span class="p">()</span>
</pre></div>
</div>
<p>Once the <cite>model</cite> and <tt class="docutils literal"><span class="pre">default_surrogate</span></tt> Slots of the MetaModel have been filled, the MetaModel
is ready for training.</p>
<blockquote>
<div></div></blockquote>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#Training the MetaModel</span>
<span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;DOE_Trainer&quot;</span><span class="p">,</span><span class="n">DOEdriver</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">DOEgenerator</span> <span class="o">=</span> <span class="n">FullFactorial</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">DOEgenerator</span><span class="o">.</span><span class="n">num_levels</span> <span class="o">=</span> <span class="mi">25</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&quot;sin_meta_model.x&quot;</span><span class="p">,</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">case_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;sin_meta_model.f_x&quot;</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s">&quot;sin_meta_model.train_next&quot;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">recorders</span> <span class="o">=</span> <span class="p">[</span><span class="n">CSVCaseRecorder</span><span class="p">()]</span>
</pre></div>
</div>
<p>In this case, we&#8217;re going to train with a DOEdriver, called <tt class="docutils literal"><span class="pre">DOE_Trainer</span></tt>.
We specify a FullFactorial DOEgenerator, which creates a set of evenly spaced
points across an interval. We (somewhat arbitrarily) selected 25 points for our training
set, specified by <tt class="docutils literal"><span class="pre">num_levels</span></tt> under the DOEgenerator. The proper training set, is of course,
highly problem dependent. The training interval is based on the low and high values
specified in the <tt class="docutils literal"><span class="pre">add_parameter</span></tt> call.</p>
<p>When the <tt class="docutils literal"><span class="pre">train_next</span></tt> event is set, MetaModel passes the inputs to the model
(i.e., Sin) to be run. By adding the <tt class="docutils literal"><span class="pre">train_next</span></tt> event to the
<tt class="docutils literal"><span class="pre">DOE_Trainer</span></tt> driver, the driver will set the <tt class="docutils literal"><span class="pre">train_next</span></tt> event in the
MetaModel driver for each iteration. The outputs generated by each training
run are stored for use in training a surrogate model. MetaModel stores the
training data internally for its own uses, but you can also specify an extra
CaseRecorder to store the training cases for your own analysis if you want.
Here this storage occurs via the use of <em>CSVCaseRecorder</em>, but you could use
any CaseRecorder here.</p>
<p>After you train a MetaModel, you want to do something with it. Here, we just run a simple validation
with another DOEDriver called <tt class="docutils literal"><span class="pre">DOE_Validate</span></tt>. This time, the Uniform  DOEGenerator was used.  This
provides a random sampling of points from within the range of input variables.  Twenty
validation points are being used in this particular case.</p>
<p>Here, we add a new instance of the sine component called <tt class="docutils literal"><span class="pre">sin_calc</span></tt>,
so we can calculate an actual and a predicted value simultaneously.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#MetaModel Validation</span>
<span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;sin_calc&quot;</span><span class="p">,</span><span class="n">Sin</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;DOE_Validate&quot;</span><span class="p">,</span><span class="n">DOEdriver</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">DOEgenerator</span> <span class="o">=</span> <span class="n">Uniform</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">DOEgenerator</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">20</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">((</span><span class="s">&quot;sin_meta_model.x&quot;</span><span class="p">,</span><span class="s">&quot;sin_calc.x&quot;</span><span class="p">),</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">case_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;sin_calc.f_x&quot;</span><span class="p">,</span><span class="s">&quot;sin_meta_model.f_x&quot;</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">recorders</span> <span class="o">=</span> <span class="p">[</span><span class="n">CSVCaseRecorder</span><span class="p">()]</span>

<span class="c">#Iteration Hierarchy</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">SequentialWorkflow</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;DOE_Trainer&#39;</span><span class="p">,</span><span class="s">&#39;DOE_Validate&#39;</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;sin_meta_model&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;sin_meta_model&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;sin_calc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that the <tt class="docutils literal"><span class="pre">train_next</span></tt> event is not added to the <tt class="docutils literal"><span class="pre">DOE_Validate</span></tt> driver like it was for for
the training driver.  MetaModel automatically runs in <cite>predict</cite> mode when this event is not set.
On any prediction run, Metamodel will check for new training data and if present, automatically train surrogate
models for each of the outputs with that data. Since training data is required to run, the training mode
must always be run prior to the running of predict mode.</p>
<p>Now, the outputs of the MetaModel will be the predicted values as determined by the surrogate
model.</p>
<p>The last thing we do is specify the workflows which control the
execution order of this example. Remember that the top driver in any assembly must be called
<cite>driver</cite>.  The type of workflow being executed is a sequential workflow,
meaning that is a simple sequence of components.</p>
<p>The following figure visually shows the iteration hierarchy for this MetaModel.  Note that
<tt class="docutils literal"><span class="pre">sin_meta_model</span></tt> appears in two workflows. This is necessary since in the training workflow
the MetaModel is trained, and within the prediction workflow, that data is used to run the
MetaModel again in order to produce predictions.  Thus it must be added to each workflow
separately.</p>
<div class="figure align-center" id="nn-metamodel-iteration-hierarchy">
<img alt="Figure shows workflows for each of 3 drivers; the workflows contain a total of 2 components" src="../../_images/metamodel_workflow.png" />
<p class="caption">View of the Iteration Hierarchy</p>
</div>
<p>Finally, the first two lines of the following code are required to actually run the
MetaModel.  The remaining code is for accessing and printing the data. Using the data recorded
by the implementation of <tt class="docutils literal"><span class="pre">DBCaseRecorder()</span></tt>, we can access and print the run data.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">sim</span> <span class="o">=</span> <span class="n">set_as_top</span><span class="p">(</span><span class="n">Simulation</span><span class="p">())</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c">#This is how you can access any of the data</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">recorders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_iterator</span><span class="p">()</span>
    <span class="n">validate_data</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">recorders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_iterator</span><span class="p">()</span>
    <span class="n">train_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="s">&#39;sin_meta_model.x&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">]</span>
    <span class="c">#Note: Kriging outputs NormalDistribution (not float), so you need to grab</span>
    <span class="c">#    the mean (.mu) or the std-deviation (.sigma) from the returned object</span>
    <span class="n">train_actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="s">&#39;sin_meta_model.f_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mu</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">]</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="s">&#39;sin_calc.x&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">validate_data</span><span class="p">]</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="s">&#39;sin_calc.f_x&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">validate_data</span><span class="p">]</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="s">&#39;sin_meta_model.f_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mu</span> <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">validate_data</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="n">predicted</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%1.3f</span><span class="s">, </span><span class="si">%1.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
<p>To view this example, and try running and modifying the code for yourself, you can download it here:
<a class="reference download internal" href="../../_downloads/krig_sin.py"><tt class="xref download docutils literal"><span class="pre">krig_sin.py</span></tt></a>.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">MetaModel</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mult_outputs.html"
                        title="next chapter">Modeling Multiple Outputs</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/tutorials/surrogate/single_output.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="mult_outputs.html" title="Modeling Multiple Outputs"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="MetaModel"
             >previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../index.html" >OpenMDAO Tutorials</a> &raquo;</li>
          <li><a href="index.html" >MetaModel</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Aug 26, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>