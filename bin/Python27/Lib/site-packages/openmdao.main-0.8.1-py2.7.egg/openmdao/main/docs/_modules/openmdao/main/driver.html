
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openmdao.main.driver &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.8.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openmdao.main.driver</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot; Driver class definition &quot;&quot;&quot;</span>

<span class="c">#public symbols</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Driver&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">fnmatch</span>

<span class="c"># pylint: disable-msg=E0611,F0401</span>

<span class="kn">from</span> <span class="nn">openmdao.main.interfaces</span> <span class="kn">import</span> <span class="n">IDriver</span><span class="p">,</span> <span class="n">ICaseRecorder</span><span class="p">,</span> <span class="n">IHasEvents</span><span class="p">,</span> \
                                     <span class="n">implements</span>
<span class="kn">from</span> <span class="nn">openmdao.main.exceptions</span> <span class="kn">import</span> <span class="n">RunStopped</span>
<span class="kn">from</span> <span class="nn">openmdao.main.expreval</span> <span class="kn">import</span> <span class="n">ExprEvaluator</span>
<span class="kn">from</span> <span class="nn">openmdao.main.component</span> <span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">openmdao.main.workflow</span> <span class="kn">import</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">openmdao.main.case</span> <span class="kn">import</span> <span class="n">Case</span>
<span class="kn">from</span> <span class="nn">openmdao.main.dataflow</span> <span class="kn">import</span> <span class="n">Dataflow</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasevents</span> <span class="kn">import</span> <span class="n">HasEvents</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasparameters</span> <span class="kn">import</span> <span class="n">HasParameters</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasconstraints</span> <span class="kn">import</span> <span class="n">HasConstraints</span><span class="p">,</span> <span class="n">HasEqConstraints</span><span class="p">,</span> \
                                         <span class="n">HasIneqConstraints</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasobjective</span> <span class="kn">import</span> <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span>
<span class="kn">from</span> <span class="nn">openmdao.util.decorators</span> <span class="kn">import</span> <span class="n">add_delegate</span>
<span class="kn">from</span> <span class="nn">openmdao.main.mp_support</span> <span class="kn">import</span> <span class="n">is_instance</span><span class="p">,</span> <span class="n">has_interface</span>
<span class="kn">from</span> <span class="nn">openmdao.main.rbac</span> <span class="kn">import</span> <span class="n">rbac</span>
<span class="kn">from</span> <span class="nn">openmdao.main.datatypes.api</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">Str</span>


<span class="nd">@add_delegate</span><span class="p">(</span><span class="n">HasEvents</span><span class="p">)</span>
<div class="viewcode-block" id="Driver"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver">[docs]</a><span class="k">class</span> <span class="nc">Driver</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A Driver iterates over a workflow of Components until some condition</span>
<span class="sd">    is met. &quot;&quot;&quot;</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IDriver</span><span class="p">,</span> <span class="n">IHasEvents</span><span class="p">)</span>

    <span class="n">recorders</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Slot</span><span class="p">(</span><span class="n">ICaseRecorder</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                     <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Case recorders for iteration data.&#39;</span><span class="p">)</span>

    <span class="c"># Extra variables for adding to CaseRecorders</span>
    <span class="n">printvars</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Str</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span>
                     <span class="n">desc</span><span class="o">=</span><span class="s">&#39;List of extra variables to output in the recorders.&#39;</span><span class="p">)</span>

    <span class="c"># set factory here so we see a default value in the docs, even</span>
    <span class="c"># though we replace it with a new Dataflow in __init__</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">factory</span><span class="o">=</span><span class="n">Dataflow</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">Dataflow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_execute</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># This flag is triggered by adding or removing any parameters,</span>
        <span class="c"># constraints, or objectives.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidated</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_workflow_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldwf</span><span class="p">,</span> <span class="n">newwf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">newwf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">newwf</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span>

<div class="viewcode-block" id="Driver.get_expr_scope"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_expr_scope">[docs]</a>    <span class="k">def</span> <span class="nf">get_expr_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the scope to be used to evaluate ExprEvaluators.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
</div>
    <span class="k">def</span> <span class="nf">_invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for delegates to declare that the driver is in an invalid</span>
<span class="sd">        state so that isvalid() returns false. Presently, this is called when</span>
<span class="sd">        a constraint/objective/parameter is set, removed, or cleared.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidated</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_exec_state</span><span class="p">(</span><span class="s">&#39;INVALID&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Driver.is_valid"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.is_valid">[docs]</a>    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return False if any Component in our workflow(s) is invalid,</span>
<span class="sd">        if any of our variables is invalid, or if the parameters,</span>
<span class="sd">        constraints, or objectives have changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># force exection if any param, obj, or constraint has changed.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invalidated</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># force execution if any component in the workflow is invalid</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_components</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comp</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Driver.check_config"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.check_config">[docs]</a>    <span class="k">def</span> <span class="nf">check_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that our workflow is able to resolve all of its components.&quot;&quot;&quot;</span>

        <span class="c"># workflow will raise an exception if it can&#39;t resolve a Component</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_workflow</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">check_config</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_update_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates workflow contents based on driver dependencies.&quot;&quot;&quot;</span>
        <span class="c"># if workflow is not defined, or if it contains only Drivers, try to</span>
        <span class="c"># use parameters, objectives and/or constraint expressions to</span>
        <span class="c"># determine the necessary workflow members</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iterset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_set</span><span class="p">())</span>
            <span class="n">alldrivers</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Driver</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_components</span><span class="p">()])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">alldrivers</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">reqcomps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_compnames</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">reqcomps</span>
                                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iterset</span><span class="p">])</span>
            <span class="c"># calling get_components() here just makes sure that all of the</span>
            <span class="c"># components can be resolved</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_components</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

<div class="viewcode-block" id="Driver.iteration_set"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.iteration_set">[docs]</a>    <span class="k">def</span> <span class="nf">iteration_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a set of all Components in our workflow(s) and</span>
<span class="sd">        recursively in any workflow in any Driver in our workflow(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allcomps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">compname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_compnames</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">compname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_components</span><span class="p">():</span>
            <span class="n">allcomps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_interface</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">IDriver</span><span class="p">):</span>
                <span class="n">allcomps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">iteration_set</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">allcomps</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.get_expr_depends"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_expr_depends">[docs]</a>    <span class="k">def</span> <span class="nf">get_expr_depends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of tuples of the form (src_comp_name,</span>
<span class="sd">        dest_comp_name) for each dependency introduced by any ExprEvaluators</span>
<span class="sd">        in this Driver, ignoring any dependencies on components that are</span>
<span class="sd">        inside of this Driver&#39;s iteration set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iternames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_set</span><span class="p">()])</span>
        <span class="n">conn_list</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_expr_depends</span><span class="p">()</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">conn_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iternames</span> <span class="ow">and</span> <span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iternames</span><span class="p">:</span>
                <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_list</span>
</div>
    <span class="k">def</span> <span class="nf">_get_required_compnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a set of names of components that are required by</span>
<span class="sd">        this Driver in order to evaluate parameters, objectives</span>
<span class="sd">        and constraints.  This list will include any intermediate</span>
<span class="sd">        components in the data flow between components referenced by</span>
<span class="sd">        parameters and those referenced by objectives and/or constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setcomps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">getcomps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">HasParameters</span><span class="p">):</span>
                    <span class="n">setcomps</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">get_referenced_compnames</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="n">HasConstraints</span><span class="p">,</span> <span class="n">HasEqConstraints</span><span class="p">,</span>
                                       <span class="n">HasIneqConstraints</span><span class="p">,</span> <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span><span class="p">)):</span>
                    <span class="n">getcomps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">get_referenced_compnames</span><span class="p">())</span>

        <span class="n">full</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">setcomps</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_depgraph</span>
            <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">getcomps</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">setcomps</span><span class="p">:</span>
                    <span class="n">full</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">find_all_connecting</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">full</span>

<div class="viewcode-block" id="Driver.get_references"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_references">[docs]</a>    <span class="k">def</span> <span class="nf">get_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return parameter, constraint, and objective references to component</span>
<span class="sd">        `name` in preparation for subsequent :meth:`restore_references` call.</span>

<span class="sd">        name: string</span>
<span class="sd">            Name of component being removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">dclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="n">HasParameters</span><span class="p">,</span> <span class="n">HasConstraints</span><span class="p">,</span>
                                     <span class="n">HasEqConstraints</span><span class="p">,</span> <span class="n">HasIneqConstraints</span><span class="p">,</span>
                                     <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span><span class="p">)):</span>
                    <span class="n">refs</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">get_references</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">refs</span>
</div>
<div class="viewcode-block" id="Driver.remove_references"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.remove_references">[docs]</a>    <span class="k">def</span> <span class="nf">remove_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove parameter, constraint, and objective references to component</span>
<span class="sd">        `name`.</span>

<span class="sd">        name: string</span>
<span class="sd">            Name of component being removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">dclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="n">HasParameters</span><span class="p">,</span> <span class="n">HasConstraints</span><span class="p">,</span>
                                     <span class="n">HasEqConstraints</span><span class="p">,</span> <span class="n">HasIneqConstraints</span><span class="p">,</span>
                                     <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span><span class="p">)):</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">remove_references</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.restore_references"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.restore_references">[docs]</a>    <span class="k">def</span> <span class="nf">restore_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refs</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore parameter, constraint, and objective references to component</span>
<span class="sd">        `name` from `refs`.</span>

<span class="sd">        name: string</span>
<span class="sd">            Name of component being removed.</span>

<span class="sd">        refs: object</span>
<span class="sd">            Value returned by :meth:`get_references`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">dclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="n">HasParameters</span><span class="p">,</span> <span class="n">HasConstraints</span><span class="p">,</span>
                                     <span class="n">HasEqConstraints</span><span class="p">,</span> <span class="n">HasIneqConstraints</span><span class="p">,</span>
                                     <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span><span class="p">)):</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">restore_references</span><span class="p">(</span><span class="n">refs</span><span class="p">[</span><span class="n">inst</span><span class="p">],</span> <span class="n">name</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="Driver.run"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ffd_order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">case_id</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run this object. This should include fetching input variables if necessary,</span>
<span class="sd">        executing, and updating output variables. Do not override this function.</span>

<span class="sd">        force: bool</span>
<span class="sd">            If True, force component to execute even if inputs have not</span>
<span class="sd">            changed. (Default is False)</span>

<span class="sd">        ffd_order: int</span>
<span class="sd">            Order of the derivatives to be used when finite differencing (1 for first</span>
<span class="sd">            derivatives, 2 for second derivativse). During regular execution,</span>
<span class="sd">            ffd_order should be 0. (Default is 0)</span>

<span class="sd">        case_id: str</span>
<span class="sd">            Identifier for the Case that is associated with this run. (Default is &#39;&#39;)</span>
<span class="sd">            If applied to the top-level assembly, this will be prepended to</span>
<span class="sd">            all iteration coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">recorder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorders</span><span class="p">:</span>
            <span class="n">recorder</span><span class="o">.</span><span class="n">startup</span><span class="p">()</span>

        <span class="c"># Override just to reset the workflow :-(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">ffd_order</span><span class="p">,</span> <span class="n">case_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidated</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Driver.execute"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over a workflow of Components until some condition</span>
<span class="sd">        is met. If you don&#39;t want to structure your driver to use *pre_iteration*,</span>
<span class="sd">        *post_iteration*, etc., just override this function. As a result, none</span>
<span class="sd">        of the ``&lt;start/pre/post/continue&gt;_iteration()`` functions will be called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_iteration</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_iteration</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_iteration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_iteration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_iteration</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.step"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Similar to the &#39;execute&#39; function, but this one only</span>
<span class="sd">        executes a single Component from the workflow each time</span>
<span class="sd">        it&#39;s called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_iteration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">raise</span>
        <span class="k">raise</span> <span class="n">RunStopped</span><span class="p">(</span><span class="s">&#39;Step complete&#39;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_iteration</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_iteration</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">junk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_workflow</span><span class="p">():</span>
                <span class="k">yield</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_iteration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_step_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">RunStopped</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">yield</span>

<div class="viewcode-block" id="Driver.stop"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.start_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.start_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">start_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called just prior to the beginning of an iteration loop. This can</span>
<span class="sd">        be overridden by inherited classes. It can be used to perform any</span>
<span class="sd">        necessary pre-iteration initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Driver.continue_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.continue_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">continue_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return False to stop iterating.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continue</span>
</div>
<div class="viewcode-block" id="Driver.pre_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.pre_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">pre_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called prior to each iteration.  This is where iteration events are set.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_events</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.run_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.run_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">run_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs workflow.&quot;&quot;&quot;</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;: workflow is empty!&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pathname</span><span class="p">())</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ffd_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ffd_order</span><span class="p">,</span> <span class="n">case_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_case_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.calc_derivatives"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.calc_derivatives">[docs]</a>    <span class="k">def</span> <span class="nf">calc_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">savebase</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate derivatives and save baseline states for all components</span>
<span class="sd">        in this workflow.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">calc_derivatives</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">savebase</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.check_derivatives"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.check_derivatives">[docs]</a>    <span class="k">def</span> <span class="nf">check_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">driver_inputs</span><span class="p">,</span> <span class="n">driver_outputs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check derivatives for all components in this workflow.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">check_derivatives</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">driver_inputs</span><span class="p">,</span> <span class="n">driver_outputs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.post_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.post_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">post_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called after each iteration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># by default, stop after one iteration</span>
</div>
<div class="viewcode-block" id="Driver.config_changed"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.config_changed">[docs]</a>    <span class="k">def</span> <span class="nf">config_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_parent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call this whenever the configuration of this Component changes,</span>
<span class="sd">        for example, children are added or removed or dependencies may have</span>
<span class="sd">        changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">config_changed</span><span class="p">(</span><span class="n">update_parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">config_changed</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.record_case"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.record_case">[docs]</a>    <span class="k">def</span> <span class="nf">record_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A driver can call this function to record the current state of the</span>
<span class="sd">        current iteration as a Case into all slotted case recorders. Generally,</span>
<span class="sd">        the driver should call this function once per iteration and may also</span>
<span class="sd">        need to call it at the conclusion.</span>

<span class="sd">        All parameters, objectives, and constraints are included in the Case</span>
<span class="sd">        output, along with all extra variables listed in self.printvars.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorders</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">case_input</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">case_output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iotypes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Parameters</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get_parameters&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">case_input</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)])</span>
                <span class="n">iotypes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;in&#39;</span>

        <span class="c"># Objectives</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;eval_objective&#39;</span><span class="p">):</span>
            <span class="n">case_output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;Objective&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_objective</span><span class="p">()])</span>

        <span class="c"># Constraints</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get_ineq_constraints&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">con</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ineq_constraints</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;&gt;&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">case_output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;Constraint ( </span><span class="si">%s</span><span class="s"> )&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                                              <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">case_output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;Constraint ( </span><span class="si">%s</span><span class="s"> )&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                                              <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get_eq_constraints&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">con</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eq_constraints</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">case_output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;Constraint ( </span><span class="si">%s</span><span class="s"> )&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">tmp_printvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printvars</span><span class="p">[:]</span>
        <span class="n">tmp_printvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.workflow.itername&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">iotypes</span><span class="p">[</span><span class="n">tmp_printvars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&#39;out&#39;</span>

        <span class="c"># Additional user-requested variables</span>
        <span class="k">for</span> <span class="n">printvar</span> <span class="ow">in</span> <span class="n">tmp_printvars</span><span class="p">:</span>

            <span class="k">if</span> <span class="s">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">printvar</span><span class="p">:</span>
                <span class="n">printvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_varpaths</span><span class="p">(</span><span class="n">printvar</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">printvars</span> <span class="o">=</span> <span class="p">[</span><span class="n">printvar</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">printvars</span><span class="p">:</span>
                <span class="n">iotype</span> <span class="o">=</span> <span class="n">iotypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">iotype</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">iotype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s">&#39;iotype&#39;</span><span class="p">)</span>
                    <span class="n">iotypes</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">iotype</span>
                <span class="k">if</span> <span class="n">iotype</span> <span class="o">==</span> <span class="s">&#39;in&#39;</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">ExprEvaluator</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
                    <span class="n">case_input</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">iotype</span> <span class="o">==</span> <span class="s">&#39;out&#39;</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">ExprEvaluator</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
                    <span class="n">case_output</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not an input or output&quot;</span> <span class="o">%</span> <span class="n">var</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span>

        <span class="n">case</span> <span class="o">=</span> <span class="n">Case</span><span class="p">(</span><span class="n">case_input</span><span class="p">,</span> <span class="n">case_output</span><span class="p">,</span> <span class="n">parent_uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_case_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">recorder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorders</span><span class="p">:</span>
            <span class="n">recorder</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_all_varpaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a list of all varpaths in the driver&#39;s workflow that</span>
<span class="sd">        match the specified pattern.</span>

<span class="sd">        Used by record_case.&#39;&#39;&#39;</span>

        <span class="c"># assume we don&#39;t want this in driver&#39;s imports</span>
        <span class="kn">from</span> <span class="nn">openmdao.main.assembly</span> <span class="kn">import</span> <span class="n">Assembly</span>

        <span class="c"># Start with our driver&#39;s settings</span>
        <span class="n">all_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_vars</span><span class="p">():</span>
            <span class="n">all_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">__iter__</span><span class="p">():</span>

            <span class="c"># All variables from components in workflow</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">list_vars</span><span class="p">():</span>
                <span class="n">all_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>

            <span class="c"># Recurse into assemblys</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">):</span>

                <span class="n">assy_header</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">assy_vars</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">_get_all_varpaths</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">assy_header</span><span class="p">)</span>
                <span class="n">all_vars</span> <span class="o">=</span> <span class="n">all_vars</span> <span class="o">+</span> <span class="n">assy_vars</span>

        <span class="c"># Match pattern in our var names</span>
        <span class="n">matched_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">matched_vars</span> <span class="o">=</span> <span class="n">all_vars</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matched_vars</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">all_vars</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">matched_vars</span>

<div class="viewcode-block" id="Driver.get_workflow"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_workflow">[docs]</a>    <span class="k">def</span> <span class="nf">get_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the driver info and the list of components that make up the</span>
<span class="sd">            driver&#39;s workflow; recurse on nested drivers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">openmdao.main.assembly</span> <span class="kn">import</span> <span class="n">Assembly</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;pathname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pathname</span><span class="p">()</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__module__</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;workflow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">:</span>
            <span class="n">pathname</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">get_pathname</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_instance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Assembly</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span><span class="o">.</span><span class="n">driver</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">&#39;workflow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s">&#39;pathname&#39;</span><span class="p">:</span> <span class="n">pathname</span><span class="p">,</span>
                    <span class="s">&#39;type&#39;</span><span class="p">:</span>     <span class="nb">type</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">__module__</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                    <span class="s">&#39;driver&#39;</span><span class="p">:</span>   <span class="n">comp</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">get_workflow</span><span class="p">(),</span>
                    <span class="s">&#39;valid&#39;</span><span class="p">:</span>    <span class="n">comp</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
                  <span class="p">})</span>
            <span class="k">elif</span> <span class="n">is_instance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Driver</span><span class="p">):</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">&#39;workflow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">get_workflow</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="s">&#39;workflow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s">&#39;pathname&#39;</span><span class="p">:</span> <span class="n">pathname</span><span class="p">,</span>
                    <span class="s">&#39;type&#39;</span><span class="p">:</span>     <span class="nb">type</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">__module__</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                    <span class="s">&#39;valid&#39;</span><span class="p">:</span>    <span class="n">comp</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
                  <span class="p">})</span>
        <span class="k">return</span> <span class="n">ret</span>

</div></div>
<span class="k">class</span> <span class="nc">Run_Once</span><span class="p">(</span><span class="n">Driver</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An assembly starts with a bare driver that just executes the workflow</span>
<span class="sd">    a single time. The only difference between this and the Driver base class</span>
<span class="sd">    is that `record_case` is called at the conclusion of the workflow execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Call parent, then record cases.&#39;&#39;&#39;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Run_Once</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_case</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.8.1</a> &raquo;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Aug 26, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>